name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
  TURBO_API: ${{ secrets.TURBO_API }}
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_REMOTE_CACHE_SIGNATURE_KEY: ${{ secrets.TURBO_REMOTE_CACHE_SIGNATURE_KEY }}

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      run-ci: ${{ steps.filter.outputs.ci }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            ci:
              - 'apps/**'
              - 'package.json'
              - 'package-lock.json'
              - 'turbo.json'
              - '.github/**'
              - 'nixpacks*.toml'
              - 'docs/**'

  lint:
    name: Lint
    needs: changes
    if: needs.changes.outputs.run-ci == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - name: Cache Turborepo artifacts
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-turbo-
      - name: Install dependencies
        run: npm ci
      - name: Validate environment schema (CI context)
        run: npm run env:check:ci
      - name: Lint
        run: npm run lint
      - name: Lockfile integrity
        run: |
          git status --porcelain
          if [ -n "$(git status --porcelain)" ]; then
            echo "Repository dirty after lint. Please commit regenerated files."
            git diff
            exit 1
          fi

  test:
    name: Test
    needs: changes
    if: needs.changes.outputs.run-ci == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - name: Cache Turborepo artifacts
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-turbo-
      - name: Install dependencies
        run: npm ci
      - name: Run tests
        run: npm run test
      - name: Audit high severity advisories
        run: npm run deps:audit

  build:
    name: Build
    needs: [lint, test]
    if: needs.changes.outputs.run-ci == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - name: Cache Turborepo artifacts
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-turbo-
      - name: Install dependencies
        run: npm ci
      - name: Build
        run: npm run build
      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-dist
          path: apps/backend/dist
          if-no-files-found: warn
      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-standalone
          path: apps/frontend/.next
          if-no-files-found: warn

